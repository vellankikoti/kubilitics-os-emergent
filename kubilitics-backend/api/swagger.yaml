openapi: 3.0.3
info:
  title: Kubilitics Backend API
  description: |
    Production-grade Kubernetes topology and management API.
    
    This API provides comprehensive Kubernetes cluster management, real-time topology visualization,
    resource operations, and WebSocket streaming for live updates.
    
    **Key Features:**
    - Multi-cluster management
    - Real-time topology graph generation with relationship inference
    - WebSocket streaming for live updates
    - Resource CRUD operations
    - Logs, metrics, and events streaming
    - Export topology in multiple formats (PNG, PDF, SVG, JSON)
    
  version: 1.0.0
  contact:
    name: Kubilitics Team
    url: https://github.com/kubilitics
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8080/api/v1
    description: Development server
  - url: http://localhost:8080/api/v1
    description: Production server (configured per deployment)

tags:
  - name: Clusters
    description: Cluster management operations
  - name: Topology
    description: Topology graph generation and export
  - name: Resources
    description: Kubernetes resource operations
  - name: Logs
    description: Pod logs streaming
  - name: Metrics
    description: Cluster and pod metrics
  - name: Events
    description: Kubernetes events
  - name: WebSocket
    description: Real-time updates via WebSocket
  - name: Health
    description: Health check endpoints

paths:
  /health:
    get:
      summary: Health check
      description: Returns the health status of the backend service
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  service:
                    type: string
                    example: kubilitics-backend
                  version:
                    type: string
                    example: "1.0.0"

  /clusters:
    get:
      summary: List all clusters
      description: Retrieve all registered Kubernetes clusters
      tags:
        - Clusters
      responses:
        '200':
          description: List of clusters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Cluster'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      summary: Add a new cluster
      description: Register a new Kubernetes cluster using kubeconfig
      tags:
        - Clusters
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - kubeconfig_path
              properties:
                kubeconfig_path:
                  type: string
                  description: Path to kubeconfig file or base64 encoded kubeconfig content
                  example: /home/user/.kube/config
                context:
                  type: string
                  description: Specific context to use (optional, defaults to current-context)
                  example: production-cluster
      responses:
        '201':
          description: Cluster added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cluster'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}:
    get:
      summary: Get cluster details
      description: Retrieve details of a specific cluster
      tags:
        - Clusters
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      responses:
        '200':
          description: Cluster details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cluster'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Remove a cluster
      description: Unregister a Kubernetes cluster
      tags:
        - Clusters
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      responses:
        '200':
          description: Cluster removed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Cluster removed
        '404':
          $ref: '#/components/responses/NotFound'

  /clusters/{id}/summary:
    get:
      summary: Get cluster summary
      description: Get aggregated statistics and summary information for a cluster
      tags:
        - Clusters
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      responses:
        '200':
          description: Cluster summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterSummary'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/topology:
    get:
      summary: Get topology graph
      description: |
        Generate complete topology graph for the cluster with all resource relationships.
        
        The topology includes:
        - All Kubernetes resources (Pods, Services, Deployments, etc.)
        - Inferred relationships (OwnerReferences, Selectors, Volumes, RBAC, etc.)
        - Deterministic layout positions
      tags:
        - Topology
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: namespace
          in: query
          description: Filter by namespace (empty = all namespaces)
          schema:
            type: string
          example: default
        - name: resource_types
          in: query
          description: Comma-separated list of resource types to include
          schema:
            type: string
          example: Pod,Service,Deployment
      responses:
        '200':
          description: Topology graph
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopologyGraph'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/topology/export:
    post:
      summary: Export topology
      description: Export topology graph in various formats (PNG, PDF, SVG, JSON)
      tags:
        - Topology
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - format
              properties:
                format:
                  type: string
                  enum: [png, pdf, svg, json]
                  example: png
                namespace:
                  type: string
                  description: Filter by namespace
                  example: default
      responses:
        '200':
          description: Exported topology file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/resources/{kind}:
    get:
      summary: List resources by kind
      description: List all resources of a specific kind (e.g., Pods, Services)
      tags:
        - Resources
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: kind
          in: path
          required: true
          description: Kubernetes resource kind (e.g., Pod, Service, Deployment)
          schema:
            type: string
          example: Pod
        - name: namespace
          in: query
          description: Namespace filter (empty = all namespaces)
          schema:
            type: string
          example: default
      responses:
        '200':
          description: List of resources
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/K8sResource'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/resources/{kind}/{namespace}/{name}:
    get:
      summary: Get a specific resource
      description: Retrieve detailed information about a specific Kubernetes resource
      tags:
        - Resources
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: kind
          in: path
          required: true
          schema:
            type: string
          example: Pod
        - name: namespace
          in: path
          required: true
          schema:
            type: string
          example: default
        - name: name
          in: path
          required: true
          schema:
            type: string
          example: nginx-deployment-7d64f8d9c5-abc12
      responses:
        '200':
          description: Resource details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/K8sResource'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete a resource
      description: Delete a specific Kubernetes resource
      tags:
        - Resources
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: kind
          in: path
          required: true
          schema:
            type: string
        - name: namespace
          in: path
          required: true
          schema:
            type: string
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Resource deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Resource deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/apply:
    post:
      summary: Apply YAML manifest
      description: Apply a Kubernetes YAML manifest to the cluster
      tags:
        - Resources
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - yaml
              properties:
                yaml:
                  type: string
                  description: YAML manifest content
                  example: |
                    apiVersion: v1
                    kind: Pod
                    metadata:
                      name: nginx
                      namespace: default
                    spec:
                      containers:
                      - name: nginx
                        image: nginx:latest
      responses:
        '200':
          description: Manifest applied successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Manifest applied successfully
                  resources:
                    type: array
                    items:
                      type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/logs/{namespace}/{pod}:
    get:
      summary: Get pod logs
      description: Stream logs from a specific pod
      tags:
        - Logs
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: namespace
          in: path
          required: true
          schema:
            type: string
          example: default
        - name: pod
          in: path
          required: true
          schema:
            type: string
          example: nginx-7d64f8d9c5-abc12
        - name: container
          in: query
          description: Container name (required for multi-container pods)
          schema:
            type: string
          example: nginx
        - name: follow
          in: query
          description: Follow log stream (real-time)
          schema:
            type: boolean
            default: false
        - name: tail
          in: query
          description: Number of lines to tail from the end
          schema:
            type: integer
            default: 100
          example: 100
        - name: since
          in: query
          description: Return logs newer than a relative duration (e.g., 10m, 1h)
          schema:
            type: string
          example: 10m
      responses:
        '200':
          description: Pod logs
          content:
            text/plain:
              schema:
                type: string
                example: |
                  2024-01-01 10:00:00 Starting nginx...
                  2024-01-01 10:00:01 nginx started successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/metrics:
    get:
      summary: Get cluster metrics
      description: Retrieve CPU and memory metrics for the entire cluster
      tags:
        - Metrics
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      responses:
        '200':
          description: Cluster metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterMetrics'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /clusters/{id}/metrics/{namespace}/{pod}:
    get:
      summary: Get pod metrics
      description: Retrieve CPU and memory metrics for a specific pod
      tags:
        - Metrics
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: namespace
          in: path
          required: true
          schema:
            type: string
        - name: pod
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pod metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PodMetrics'
        '404':
          $ref: '#/components/responses/NotFound'

  /clusters/{id}/events:
    get:
      summary: Get Kubernetes events
      description: Retrieve events from the cluster
      tags:
        - Events
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - name: namespace
          in: query
          description: Filter by namespace
          schema:
            type: string
        - name: resource_kind
          in: query
          description: Filter by resource kind
          schema:
            type: string
          example: Pod
        - name: resource_name
          in: query
          description: Filter by resource name
          schema:
            type: string
        - name: limit
          in: query
          description: Maximum number of events to return
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/K8sEvent'
        '404':
          $ref: '#/components/responses/NotFound'

  /ws/resources:
    get:
      summary: WebSocket connection for resource updates
      description: |
        Establish WebSocket connection to receive real-time Kubernetes resource updates.
        
        **Connection URL**: `ws://localhost:8080/ws/resources?cluster_id={id}&namespace={ns}`
        
        **Message Format**:
        ```json
        {
          "type": "RESOURCE_ADDED" | "RESOURCE_UPDATED" | "RESOURCE_DELETED",
          "cluster_id": "cluster-uuid",
          "resource": {
            "kind": "Pod",
            "namespace": "default",
            "name": "nginx-abc123",
            "data": { ... }
          },
          "timestamp": "2024-01-01T10:00:00Z"
        }
        ```
      tags:
        - WebSocket
      parameters:
        - name: cluster_id
          in: query
          required: true
          schema:
            type: string
        - name: namespace
          in: query
          description: Filter updates by namespace
          schema:
            type: string
      responses:
        '101':
          description: Switching Protocols - WebSocket connection established
        '400':
          description: Bad Request - Invalid parameters
        '401':
          description: Unauthorized

  /ws/topology:
    get:
      summary: WebSocket connection for topology updates
      description: |
        Establish WebSocket connection to receive real-time topology graph updates.
        
        **Connection URL**: `ws://localhost:8080/ws/topology?cluster_id={id}`
        
        **Message Format**:
        ```json
        {
          "type": "TOPOLOGY_UPDATED",
          "cluster_id": "cluster-uuid",
          "changes": {
            "nodes_added": [ ... ],
            "nodes_updated": [ ... ],
            "nodes_removed": [ ... ],
            "edges_added": [ ... ],
            "edges_removed": [ ... ]
          },
          "timestamp": "2024-01-01T10:00:00Z"
        }
        ```
      tags:
        - WebSocket
      parameters:
        - name: cluster_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '101':
          description: Switching Protocols - WebSocket connection established

components:
  parameters:
    ClusterId:
      name: id
      in: path
      required: true
      description: Cluster UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

  schemas:
    Cluster:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: production-cluster
        context:
          type: string
          example: production-context
        server:
          type: string
          example: https://api.k8s.example.com
        version:
          type: string
          example: v1.28.0
        node_count:
          type: integer
          example: 5
        namespace_count:
          type: integer
          example: 12
        created_at:
          type: string
          format: date-time
          example: "2024-01-01T10:00:00Z"
        last_connected:
          type: string
          format: date-time
          example: "2024-01-01T11:30:00Z"
        status:
          type: string
          enum: [connected, disconnected, error]
          example: connected

    ClusterSummary:
      type: object
      properties:
        cluster_id:
          type: string
          format: uuid
        total_nodes:
          type: integer
          example: 5
        total_pods:
          type: integer
          example: 120
        total_services:
          type: integer
          example: 30
        total_deployments:
          type: integer
          example: 25
        total_namespaces:
          type: integer
          example: 12
        running_pods:
          type: integer
          example: 115
        pending_pods:
          type: integer
          example: 3
        failed_pods:
          type: integer
          example: 2
        cpu_usage_percent:
          type: number
          format: float
          example: 65.5
        memory_usage_percent:
          type: number
          format: float
          example: 72.3

    TopologyGraph:
      type: object
      properties:
        cluster_id:
          type: string
          format: uuid
        namespace:
          type: string
          example: default
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/TopologyNode'
        edges:
          type: array
          items:
            $ref: '#/components/schemas/TopologyEdge'
        meta:
          type: object
          properties:
            node_count:
              type: integer
            edge_count:
              type: integer
            generated_at:
              type: string
              format: date-time
            layout_seed:
              type: string
              description: Deterministic seed for consistent graph layout

    TopologyNode:
      type: object
      properties:
        id:
          type: string
          example: pod-default-nginx-abc123
        type:
          type: string
          example: Pod
        name:
          type: string
          example: nginx-abc123
        namespace:
          type: string
          example: default
        labels:
          type: object
          additionalProperties:
            type: string
          example:
            app: nginx
            version: v1.0
        status:
          type: string
          enum: [Running, Pending, Failed, Succeeded, Unknown]
          example: Running
        metadata:
          type: object
          additionalProperties: true
          description: Additional resource-specific metadata

    TopologyEdge:
      type: object
      properties:
        id:
          type: string
          example: edge-1234
        source:
          type: string
          description: Source node ID
          example: deployment-default-nginx
        target:
          type: string
          description: Target node ID
          example: replicaset-default-nginx-xyz789
        type:
          type: string
          enum: [owner, selector, volume, env, rbac, network, storage, node, autoscaling, job]
          example: owner
        label:
          type: string
          example: owns

    K8sResource:
      type: object
      properties:
        kind:
          type: string
          example: Pod
        api_version:
          type: string
          example: v1
        namespace:
          type: string
          example: default
        name:
          type: string
          example: nginx-abc123
        labels:
          type: object
          additionalProperties:
            type: string
        annotations:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time
        spec:
          type: object
          additionalProperties: true
        status:
          type: object
          additionalProperties: true

    ClusterMetrics:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        node_metrics:
          type: array
          items:
            type: object
            properties:
              node_name:
                type: string
              cpu_usage:
                type: string
                example: "1200m"
              memory_usage:
                type: string
                example: "4Gi"
              cpu_capacity:
                type: string
                example: "4000m"
              memory_capacity:
                type: string
                example: "16Gi"

    PodMetrics:
      type: object
      properties:
        namespace:
          type: string
        pod_name:
          type: string
        timestamp:
          type: string
          format: date-time
        containers:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              cpu_usage:
                type: string
                example: "100m"
              memory_usage:
                type: string
                example: "256Mi"

    K8sEvent:
      type: object
      properties:
        namespace:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [Normal, Warning]
          example: Normal
        reason:
          type: string
          example: Started
        message:
          type: string
          example: Started container nginx
        involved_object:
          type: object
          properties:
            kind:
              type: string
            namespace:
              type: string
            name:
              type: string
        first_timestamp:
          type: string
          format: date-time
        last_timestamp:
          type: string
          format: date-time
        count:
          type: integer
          example: 1

  responses:
    BadRequest:
      description: Bad Request - Invalid input
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Invalid request body

    NotFound:
      description: Not Found - Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Cluster not found

    InternalError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Internal server error
