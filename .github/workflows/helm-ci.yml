name: Helm Chart CI

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'deploy/helm/kubilitics/**'
      - '.github/workflows/helm-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'deploy/helm/kubilitics/**'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish chart to OCI registry'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write

concurrency:
  group: helm-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Lint chart
        working-directory: deploy/helm/kubilitics
        run: |
          helm lint .
          helm dependency update .
          helm dependency build .

      - name: Validate chart values
        working-directory: deploy/helm/kubilitics
        run: |
          # Test with default values
          helm template . --debug --dry-run > /dev/null
          
          # Test with PostgreSQL enabled
          helm template . --debug --dry-run \
            --set database.type=postgresql \
            --set postgresql.enabled=true > /dev/null
          
          # Test with frontend enabled
          helm template . --debug --dry-run \
            --set frontend.enabled=true > /dev/null
          
          # Test with AI enabled
          helm template . --debug --dry-run \
            --set ai.enabled=true > /dev/null
          
          # Test with all components enabled
          helm template . --debug --dry-run \
            --set database.type=postgresql \
            --set postgresql.enabled=true \
            --set frontend.enabled=true \
            --set ai.enabled=true \
            --set ingress.enabled=true > /dev/null
          
          echo "✓ All value combinations validated successfully"

  test:
    name: Test Chart
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Install kind
        uses: helm/kind-action@v1
        with:
          install_kind: true
          install_kubectl: true

      - name: Create kind cluster
        run: |
          kind create cluster --wait 5m --config=- <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
          EOF

      - name: Install chart with test values
        working-directory: deploy/helm/kubilitics
        run: |
          helm dependency update .
          helm install kubilitics-test . \
            --namespace kubilitics-test \
            --create-namespace \
            --set replicaCount=1 \
            --set persistence.enabled=false \
            --set rbac.enabled=false \
            --set serviceAccount.create=false \
            --wait --timeout 10m

      - name: Wait for pods to be ready
        run: |
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=kubilitics \
            -n kubilitics-test \
            --timeout=5m || true

      - name: Run Helm tests
        working-directory: deploy/helm/kubilitics
        run: |
          # Run Helm tests (if any test pods exist)
          helm test kubilitics-test --namespace kubilitics-test --timeout 5m || echo "No tests to run or tests failed"

      - name: Cleanup
        if: always()
        working-directory: deploy/helm/kubilitics
        run: |
          helm uninstall kubilitics-test --namespace kubilitics-test || true
          kubectl delete namespace kubilitics-test --wait=false || true

  package:
    name: Package Chart
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Extract chart version
        id: chart-version
        working-directory: deploy/helm/kubilitics
        run: |
          VERSION=$(helm show chart . | grep '^version:' | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Package chart
        working-directory: deploy/helm/kubilitics
        run: |
          helm dependency update .
          helm package . --destination ./packaged
          ls -lh ./packaged/

      - name: Upload chart artifact
        uses: actions/upload-artifact@v6
        with:
          name: helm-chart-${{ steps.chart-version.outputs.version }}
          path: deploy/helm/kubilitics/packaged/*.tgz
          retention-days: 30

  publish:
    name: Publish Chart to OCI
    runs-on: ubuntu-latest
    needs: [lint, package]
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Download chart artifact
        uses: actions/download-artifact@v7
        with:
          # FIX: pattern matches artifact *names* not filenames — the artifact is named
          # "helm-chart-{version}" (no .tgz suffix), so the old pattern never matched.
          pattern: helm-chart-*
          path: ./charts
          merge-multiple: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract chart version and name
        id: chart-info
        run: |
          CHART_FILE=$(ls ./charts/*.tgz | head -1)
          CHART_NAME=$(basename "$CHART_FILE" .tgz | sed 's/-[0-9].*//')
          CHART_VERSION=$(basename "$CHART_FILE" .tgz | sed 's/.*-//')
          echo "name=$CHART_NAME" >> $GITHUB_OUTPUT
          echo "version=$CHART_VERSION" >> $GITHUB_OUTPUT
          echo "file=$CHART_FILE" >> $GITHUB_OUTPUT
          echo "Chart: $CHART_NAME version $CHART_VERSION"

      - name: Push chart to OCI registry
        run: |
          # Helm push automatically uses the version from Chart.yaml
          helm push ${{ steps.chart-info.outputs.file }} \
            oci://ghcr.io/${{ github.repository_owner }}/charts
          
          echo "✓ Chart pushed: oci://ghcr.io/${{ github.repository_owner }}/charts/${{ steps.chart-info.outputs.name }}:${{ steps.chart-info.outputs.version }}"

      - name: Output chart location
        run: |
          echo "Chart published to: oci://ghcr.io/${{ github.repository_owner }}/charts/${{ steps.chart-info.outputs.name }}:${{ steps.chart-info.outputs.version }}"
          echo ""
          echo "To install from OCI registry:"
          echo "  helm install kubilitics oci://ghcr.io/${{ github.repository_owner }}/charts/kubilitics --version ${{ steps.chart-info.outputs.version }}"
