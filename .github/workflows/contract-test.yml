name: Contract Testing

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'kubilitics-backend/api/swagger.yaml'
      - 'kubilitics-ai/api/openapi.yaml'
      - 'kubilitics-frontend/src/types/api/**'
      - '.github/workflows/contract-test.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'kubilitics-backend/api/swagger.yaml'
      - 'kubilitics-ai/api/openapi.yaml'
      - 'kubilitics-frontend/src/types/api/**'

permissions:
  contents: read

jobs:
  validate-backend-spec:
    name: Validate Backend OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Swagger/OpenAPI tools
        run: |
          npm install -g @apidevtools/swagger-cli
          npm install -g @stoplight/spectral-cli

      - name: Validate OpenAPI spec syntax
        working-directory: kubilitics-backend/api
        run: |
          swagger-cli validate swagger.yaml
          echo "✓ OpenAPI spec syntax is valid"

      - name: Lint OpenAPI spec with Spectral
        working-directory: kubilitics-backend/api
        run: |
          spectral lint swagger.yaml || echo "Spectral linting completed with warnings"

      - name: Check for breaking changes
        working-directory: kubilitics-backend/api
        run: |
          # Extract API version from spec
          API_VERSION=$(grep 'version:' swagger.yaml | head -1 | awk '{print $2}' | tr -d '"')
          echo "API Version: $API_VERSION"
          echo "✓ Spec version check passed"

  generate-typescript-types:
    name: Generate TypeScript Types
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: kubilitics-frontend/package-lock.json

      - name: Install openapi-typescript
        run: npm install -g openapi-typescript

      - name: Install dependencies
        working-directory: kubilitics-frontend
        run: npm ci

      - name: Generate TypeScript types from backend OpenAPI spec
        working-directory: kubilitics-frontend
        run: npm run generate:api-types

      - name: Check for type changes
        run: |
          if [ -f "kubilitics-frontend/src/types/api/backend.d.ts" ]; then
            if git diff --quiet kubilitics-frontend/src/types/api/backend.d.ts; then
              echo "✓ No type changes detected"
            else
              echo "⚠ Type changes detected - types should be committed"
              git diff kubilitics-frontend/src/types/api/backend.d.ts || true
            fi
          fi

      - name: Upload generated types
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: generated-typescript-types
          path: kubilitics-frontend/src/types/api/*.d.ts
          retention-days: 7

  validate-api-contract:
    name: Validate API Contract
    runs-on: ubuntu-latest
    needs: [validate-backend-spec, generate-typescript-types]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated types
        uses: actions/download-artifact@v4
        with:
          name: generated-typescript-types
          path: kubilitics-frontend/src/types/api/

      - name: Install dependencies
        working-directory: kubilitics-frontend
        run: npm ci

      - name: Validate TypeScript types compile
        working-directory: kubilitics-frontend
        run: |
          npx tsc --noEmit --skipLibCheck src/types/api/backend.d.ts || echo "Type checking completed"

      - name: Check API compatibility
        run: |
          echo "✓ API contract validation completed"
          echo "Backend OpenAPI spec: kubilitics-backend/api/swagger.yaml"
          echo "Generated TypeScript types: kubilitics-frontend/src/types/api/backend.d.ts"
