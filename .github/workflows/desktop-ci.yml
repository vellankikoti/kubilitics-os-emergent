name: Desktop CI

# Runs only when Tauri/Rust desktop code changes.
# Full cross-platform builds happen in release.yml on version tags.
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'kubilitics-desktop/src-tauri/**'
      - '.github/workflows/desktop-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'kubilitics-desktop/src-tauri/**'
  workflow_dispatch:

concurrency:
  group: desktop-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Rust unit tests (single platform – fast) ──────────────────────────────
  test:
    name: Rust Tests (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            kubilitics-desktop/src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('kubilitics-desktop/src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Create stub sidecar binaries for Linux CI
        # tauri_build::build() validates that every externalBin path in tauri.conf.json
        # exists on disk for the current target triple — it runs even during `cargo test`.
        # Only macOS binaries are committed; we create empty Linux stubs so the build
        # script passes without requiring a full cross-compile of the Go backends.
        run: |
          TRIPLE="x86_64-unknown-linux-gnu"
          mkdir -p kubilitics-desktop/src-tauri/binaries
          for bin in kubilitics-backend kubilitics-ai kcli; do
            stub="kubilitics-desktop/src-tauri/binaries/${bin}-${TRIPLE}"
            if [ ! -f "$stub" ]; then
              echo "#!/bin/sh" > "$stub"
              chmod +x "$stub"
              echo "Created stub: $stub"
            fi
          done

      - name: Run Rust tests
        working-directory: kubilitics-desktop/src-tauri
        run: cargo test

  # ── Compile check (no bundle) – verifies Tauri builds on each OS ──────────
  # Only runs on PRs and manual dispatch to keep push builds fast.
  compile-check:
    name: Compile Check (${{ matrix.os }})
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install system deps (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev librsvg2-dev

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            kubilitics-desktop/src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('kubilitics-desktop/src-tauri/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Cargo check (no build artifacts)
        working-directory: kubilitics-desktop/src-tauri
        run: cargo check
