{{- if .Values.ai.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "kubilitics.fullname" . }}-ai
  labels:
    {{- include "kubilitics.labels" . | nindent 4 }}
    app.kubernetes.io/component: ai-backend
spec:
  replicas: {{ .Values.ai.replicaCount }}
  selector:
    matchLabels:
      {{- include "kubilitics.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: ai-backend
  template:
    metadata:
      labels:
        {{- include "kubilitics.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: ai-backend
    spec:
      {{- include "kubilitics.imagePullSecrets" . | nindent 6 }}
      {{- if .Values.ai.serviceAccount.create }}
      serviceAccountName: {{ .Values.ai.serviceAccount.name | default (printf "%s-ai" (include "kubilitics.serviceAccountName" .)) }}
      {{- end }}
      securityContext:
        {{- include "kubilitics.podSecurityContext" . | nindent 8 }}
      containers:
        - name: ai-backend
          image: "{{ .Values.ai.image.repository }}:{{ .Values.ai.image.tag }}"
          imagePullPolicy: {{ .Values.ai.image.pullPolicy }}
          securityContext:
            {{- include "kubilitics.containerSecurityContext" . | nindent 12 }}
          ports:
            - name: http
              containerPort: {{ .Values.ai.config.serverPort }}
              protocol: TCP
          env:
            - name: KUBILITICS_HTTP_PORT
              value: {{ .Values.ai.config.serverPort | quote }}
            - name: KUBILITICS_BACKEND_ADDRESS
              value: {{ .Values.ai.config.backendAddress | quote }}
            - name: KUBILITICS_BACKEND_URL
              value: {{ .Values.ai.config.backendHttpUrl | quote }}
            - name: KUBILITICS_BACKEND_TIMEOUT
              value: {{ .Values.ai.config.backendTimeout | quote }}
            - name: KUBILITICS_BACKEND_TLS_ENABLED
              value: {{ .Values.ai.config.backendTLSEnabled | quote }}
            - name: KUBILITICS_LLM_PROVIDER
              value: {{ .Values.ai.config.llmProvider | quote }}
            {{- if .Values.ai.config.llmOpenAIModel }}
            - name: KUBILITICS_LLM_OPENAI_MODEL
              value: {{ .Values.ai.config.llmOpenAIModel | quote }}
            {{- end }}
            {{- if .Values.ai.config.llmAnthropicModel }}
            - name: KUBILITICS_LLM_ANTHROPIC_MODEL
              value: {{ .Values.ai.config.llmAnthropicModel | quote }}
            {{- end }}
            {{- if .Values.ai.config.llmOllamaBaseURL }}
            - name: KUBILITICS_LLM_OLLAMA_BASE_URL
              value: {{ .Values.ai.config.llmOllamaBaseURL | quote }}
            {{- end }}
            {{- if .Values.ai.config.llmOllamaModel }}
            - name: KUBILITICS_LLM_OLLAMA_MODEL
              value: {{ .Values.ai.config.llmOllamaModel | quote }}
            {{- end }}
            - name: KUBILITICS_DATABASE_TYPE
              value: {{ .Values.ai.config.databaseType | quote }}
            - name: KUBILITICS_DATABASE_PATH
              value: {{ .Values.ai.config.databasePath | quote }}
            - name: KUBILITICS_AUTONOMY_DEFAULT_LEVEL
              value: {{ .Values.ai.config.autonomyDefaultLevel | quote }}
            - name: KUBILITICS_AUTONOMY_ALLOW_LEVEL_OVERRIDE
              value: {{ .Values.ai.config.autonomyAllowLevelOverride | quote }}
            {{- if .Values.ai.secret.enabled }}
            {{- if .Values.ai.secret.openaiApiKey }}
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "kubilitics.aiSecretName" . }}
                  key: openai-api-key
            {{- end }}
            {{- if .Values.ai.secret.anthropicApiKey }}
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "kubilitics.aiSecretName" . }}
                  key: anthropic-api-key
            {{- end }}
            {{- if .Values.ai.secret.ollamaApiKey }}
            - name: OLLAMA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "kubilitics.aiSecretName" . }}
                  key: ollama-api-key
            {{- end }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            {{- toYaml .Values.ai.resources | nindent 12 }}
          volumeMounts:
            - name: ai-data
              mountPath: /var/lib/kubilitics
            {{- if and .Values.ai.config.tlsEnabled .Values.ai.tls.enabled .Values.ai.tls.secretName }}
            - name: tls-certs
              mountPath: /etc/tls
              readOnly: true
            {{- end }}
      volumes:
        - name: ai-data
          {{- if .Values.ai.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ include "kubilitics.fullname" . }}-ai-pvc
          {{- else }}
          emptyDir: {}
          {{- end }}
        {{- if and .Values.ai.config.tlsEnabled .Values.ai.tls.enabled .Values.ai.tls.secretName }}
        - name: tls-certs
          secret:
            secretName: {{ .Values.ai.tls.secretName }}
        {{- end }}
      {{- with .Values.ai.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.ai.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.ai.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
