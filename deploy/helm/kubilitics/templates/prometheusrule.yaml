{{- if .Values.serviceMonitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "kubilitics.fullname" . }}-alerts
  namespace: {{ .Values.namespace | default .Release.Namespace }}
  labels:
    {{- include "kubilitics.labels" . | nindent 4 }}
    prometheus: kube-prometheus
    role: alert-rules
spec:
  groups:
  - name: kubilitics_backend
    interval: 30s
    rules:
    # High error rate
    - alert: KubiliticsHighErrorRate
      expr: |
        sum(rate(kubilitics_http_requests_total{status=~"5.."}[5m])) by (path) > 0.1
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High error rate detected"
        description: "Path {{ $labels.path }} has error rate > 0.1 req/s for 5 minutes"

    # Circuit breaker open
    - alert: KubiliticsCircuitBreakerOpen
      expr: |
        kubilitics_circuit_breaker_state{cluster_id!=""} == 1
      for: 2m
      labels:
        severity: critical
        component: backend
      annotations:
        summary: "Circuit breaker is open"
        description: "Circuit breaker for cluster {{ $labels.cluster_id }} has been open for 2 minutes"

    # High latency
    - alert: KubiliticsHighLatency
      expr: |
        histogram_quantile(0.95, sum(rate(kubilitics_http_request_duration_seconds_bucket[5m])) by (le, path)) > 2
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High request latency"
        description: "95th percentile latency for {{ $labels.path }} exceeds 2 seconds"

    # Database connectivity issues
    - alert: KubiliticsDatabaseUnavailable
      expr: |
        up{job="kubilitics-backend"} == 1 and kubilitics_db_query_duration_seconds_count == 0
      for: 2m
      labels:
        severity: critical
        component: backend
      annotations:
        summary: "Database appears unavailable"
        description: "No database queries observed for 2 minutes despite backend being up"

    # High database query latency
    - alert: KubiliticsHighDatabaseLatency
      expr: |
        histogram_quantile(0.95, sum(rate(kubilitics_db_query_duration_seconds_bucket[5m])) by (le, operation)) > 0.5
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High database query latency"
        description: "95th percentile database query latency for {{ $labels.operation }} exceeds 500ms"

    # Token cleanup failures
    - alert: KubiliticsTokenCleanupStalled
      expr: |
        increase(kubilitics_token_cleanup_deleted_total[1h]) == 0 and kubilitics_token_cleanup_deleted_total > 0
      for: 2h
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "Token cleanup appears stalled"
        description: "No tokens cleaned in the last 2 hours despite previous cleanup activity"

    # WebSocket connection issues
    - alert: KubiliticsWebSocketHighDisconnectRate
      expr: |
        rate(kubilitics_websocket_connections_active[5m]) < -0.1
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High WebSocket disconnect rate"
        description: "WebSocket connections dropping at rate > 0.1/sec"

    # kcli execution failures
    - alert: KubiliticsKCLIHighFailureRate
      expr: |
        sum(rate(kubilitics_kcli_exec_total{outcome="failure"}[5m])) by (command) / sum(rate(kubilitics_kcli_exec_total[5m])) by (command) > 0.2
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "High kcli failure rate"
        description: "kcli command {{ $labels.command }} has failure rate > 20%"

    # Topology build timeout
    - alert: KubiliticsTopologyBuildTimeout
      expr: |
        histogram_quantile(0.95, rate(kubilitics_topology_build_duration_seconds_bucket[5m])) > 25
      for: 5m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "Topology builds approaching timeout"
        description: "95th percentile topology build time exceeds 25 seconds (timeout is 30s)"

    # Auth failure spike
    - alert: KubiliticsAuthFailureSpike
      expr: |
        sum(rate(kubilitics_auth_login_attempts_total{outcome="failure"}[5m])) > 10
      for: 2m
      labels:
        severity: warning
        component: backend
      annotations:
        summary: "Authentication failure spike"
        description: "More than 10 failed login attempts per second for 2 minutes - possible brute force attack"
{{- end }}
