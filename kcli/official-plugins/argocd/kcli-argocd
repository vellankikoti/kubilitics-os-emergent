#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
kcli-argocd - Argo CD workflows

Usage:
  kcli argocd apps [namespace]
  kcli argocd sync <app> [namespace]
  kcli argocd history <app> [namespace]
USAGE
}

ns_arg() {
  local ns="${1:-argocd}"
  echo "-n" "$ns"
}

cmd="${1:-}"
case "$cmd" in
  apps)
    ns="${2:-argocd}"
    kubectl get applications.argoproj.io $(ns_arg "$ns")
    ;;
  sync)
    app="${2:-}"
    ns="${3:-argocd}"
    [[ -n "$app" ]] || { usage; exit 1; }
    kubectl annotate applications.argoproj.io "$app" argocd.argoproj.io/refresh=hard --overwrite $(ns_arg "$ns")
    ;;
  history)
    app="${2:-}"
    ns="${3:-argocd}"
    [[ -n "$app" ]] || { usage; exit 1; }
    kubectl get applications.argoproj.io "$app" -o jsonpath='{.status.history}' $(ns_arg "$ns")
    ;;
  *)
    usage
    ;;
esac
