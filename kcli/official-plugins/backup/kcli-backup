#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
kcli-backup - Velero backup commands

Usage:
  kcli backup list [namespace]
  kcli backup create <name> [namespace]
  kcli backup restores [namespace]
USAGE
}

ns_arg() {
  local ns="${1:-velero}"
  echo "-n" "$ns"
}

cmd="${1:-}"
case "$cmd" in
  list)
    ns="${2:-velero}"
    kubectl get backups.velero.io $(ns_arg "$ns")
    ;;
  create)
    name="${2:-}"
    ns="${3:-velero}"
    [[ -n "$name" ]] || { usage; exit 1; }
    kubectl create -f - <<YAML
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: ${name}
  namespace: ${ns}
spec:
  includedNamespaces:
  - '*'
YAML
    ;;
  restores)
    ns="${2:-velero}"
    kubectl get restores.velero.io $(ns_arg "$ns")
    ;;
  *)
    usage
    ;;
esac
