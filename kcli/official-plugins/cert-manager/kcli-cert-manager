#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
kcli-cert-manager - cert-manager workflows

Usage:
  kcli cert-manager list [namespace]
  kcli cert-manager describe <name> [namespace]
  kcli cert-manager renew <name> [namespace]
USAGE
}

ns_arg() {
  local ns="${1:-}"
  if [[ -n "$ns" ]]; then
    echo "-n" "$ns"
  fi
}

cmd="${1:-}"
case "$cmd" in
  list)
    ns="${2:-}"
    kubectl get certificates $(ns_arg "$ns")
    ;;
  describe)
    name="${2:-}"
    ns="${3:-}"
    [[ -n "$name" ]] || { usage; exit 1; }
    kubectl describe certificate "$name" $(ns_arg "$ns")
    ;;
  renew)
    name="${2:-}"
    ns="${3:-}"
    [[ -n "$name" ]] || { usage; exit 1; }
    kubectl annotate certificate "$name" cert-manager.io/renew-reason="manual-$(date +%s)" --overwrite $(ns_arg "$ns")
    ;;
  *)
    usage
    ;;
esac
